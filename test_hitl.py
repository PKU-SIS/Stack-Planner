from ast import parse
from concurrent.futures import thread
from tkinter import NO
import httpx
import json

url = "http://localhost:8513/api/chat/sp_stream"
# content = """æ–°åç¤¾åŒ—äº¬6æœˆ9æ—¥ç”µ

# ä¸­å…±ä¸­å¤®åŠå…¬å…â€‚å›½åŠ¡é™¢åŠå…¬å…å…³äºè¿›ä¸€æ­¥ä¿éšœå’Œæ”¹å–„æ°‘ç”Ÿâ€‚ç€åŠ›è§£å†³ç¾¤ä¼—æ€¥éš¾æ„ç›¼çš„æ„è§
# ï¼ˆ2025å¹´3æœˆ2æ—¥ï¼‰

# ä¸ºè¿›ä¸€æ­¥ä¿éšœå’Œæ”¹å–„æ°‘ç”Ÿï¼Œç€åŠ›è§£å†³ç¾¤ä¼—æ€¥éš¾æ„ç›¼ï¼Œæ¨åŠ¨æ°‘ç”Ÿå»ºè®¾æ›´åŠ å…¬å¹³ã€å‡è¡¡ã€æ™®æƒ ã€å¯åŠï¼Œç»å…šä¸­å¤®ã€å›½åŠ¡é™¢åŒæ„ï¼Œç°æå‡ºå¦‚ä¸‹æ„è§ã€‚

# ä¸€ã€å¢å¼ºç¤¾ä¼šä¿éšœå…¬å¹³æ€§

# ï¼ˆä¸€ï¼‰æœ‰æ•ˆæ‰©å¤§ç¤¾ä¼šä¿éšœè¦†ç›–é¢ã€‚å¼ºåŒ–ç¤¾ä¼šä¿é™©åœ¨ç¤¾ä¼šä¿éšœä½“ç³»ä¸­çš„ä¸»ä½“ä½œç”¨ï¼Œå¥å…¨çµæ´»å°±ä¸šäººå‘˜ã€å†œæ°‘å·¥ã€æ–°å°±ä¸šå½¢æ€äººå‘˜ç¤¾ä¼šä¿é™©åˆ¶åº¦ï¼Œå…¨é¢å–æ¶ˆåœ¨å°±ä¸šåœ°å‚åŠ ç¤¾ä¼šä¿é™©çš„æˆ·ç±é™åˆ¶ï¼Œå¥å…¨å‚ä¿æ¿€åŠ±çº¦æŸæœºåˆ¶ï¼Œå®Œå–„è½¬ç§»æ¥ç»­æœºåˆ¶ï¼Œç¨³å¦¥æœ‰åºæé«˜åŸé•‡å°±ä¸šäººå‘˜å‚åŠ èŒå·¥åŸºæœ¬å…»è€ä¿é™©å’ŒåŒ»ç–—ä¿é™©æ¯”ä¾‹ã€‚ä¼˜åŒ–åŸä¹¡å±…æ°‘åŸºæœ¬å…»è€ä¿é™©ç¼´è´¹æ¡£æ¬¡è®¾ç½®ï¼Œåˆç†ç¡®å®šç¼´è´¹è¡¥è´´æ°´å¹³ï¼Œé€‚å½“å¢åŠ ç¼´è´¹çµæ´»æ€§ï¼Œå¥å…¨å¤šç¼´å¤šå¾—æ¿€åŠ±æœºåˆ¶ã€‚å¯¹ç¬¦åˆæ¡ä»¶çš„é«˜æ ¡æ¯•ä¸šç”Ÿã€å°±ä¸šå›°éš¾äººå‘˜ç­‰äºˆä»¥ç¤¾ä¼šä¿é™©è¡¥è´´ã€‚å¥å…¨åŸä¹¡å±…æ°‘åŸºæœ¬åŒ»ç–—ä¿é™©ç­¹èµ„æœºåˆ¶ï¼Œæ¨åŠ¨ç¼´è´¹ä¸åŸä¹¡å±…æ°‘äººå‡å¯æ”¯é…æ”¶å…¥ç›¸æŒ‚é’©ï¼Œå¯¹è¿ç»­å‚ä¿å’Œå½“å¹´é›¶æŠ¥é”€äººå‘˜æŒ‰è§„å®šæé«˜æ¬¡å¹´å¤§ç—…ä¿é™©æœ€é«˜æ”¯ä»˜é™é¢ï¼Œæœ‰åºæ¨è¿›èŒå·¥åŸºæœ¬åŒ»ç–—ä¿é™©ä¸ªäººè´¦æˆ·è·¨çœå…±æµã€‚ç»§ç»­å°†æŠ€èƒ½æå‡è¡¥è´´ç”³é¢†å¯¹è±¡æ”¾å®½è‡³é¢†å–å¤±ä¸šä¿é™©é‡‘äººå‘˜ã€‚æ”¯æŒå¼•å¯¼æœ‰æ¡ä»¶çš„åœ°æ–¹å°†ç”Ÿè‚²ä¿é™©ç”Ÿè‚²æ´¥è´´æŒ‰ç¨‹åºç›´æ¥å‘æ”¾ç»™å‚ä¿äººã€‚åŠ å¼ºç¤¾ä¼šä¿é™©ä¸ç¤¾ä¼šæ•‘åŠ©ã€ç¤¾ä¼šç¦åˆ©åˆ¶åº¦è¡”æ¥ï¼Œç²¾å‡†è½å®ä¸ºå›°éš¾ç¾¤ä½“ä»£ç¼´åŸä¹¡å±…æ°‘ç¤¾ä¼šä¿é™©è´¹æ”¿ç­–ï¼Œå¢å¼ºä½æ”¶å…¥äººå£æŠ—é£é™©èƒ½åŠ›ã€‚

# ï¼ˆäºŒï¼‰åŠ å¼ºä½æ”¶å…¥ç¾¤ä½“å…œåº•å¸®æ‰¶ã€‚å……åˆ†è¿ç”¨å¤§æ•°æ®æ¯”å¯¹ä¸å®åœ°æ‘¸æ’ç›¸ç»“åˆç­‰æ–¹å¼ï¼ŒåŠ å¼ºåŠ¨æ€ç›‘æµ‹é¢„è­¦ï¼ŒåŠæ—¶å°†ç¬¦åˆæ¡ä»¶çš„ç¾¤ä¼—çº³å…¥ç¤¾ä¼šæ•‘åŠ©èŒƒå›´ã€‚åˆ¶å®šä½æ”¶å…¥äººå£è®¤å®šåŠæ³•ã€ä½æ”¶å…¥å®¶åº­ç»æµçŠ¶å†µæ ¸å¯¹åŠæ³•ï¼Œå…¨é¢å¼€å±•ä½ä¿è¾¹ç¼˜å®¶åº­ã€åˆšæ€§æ”¯å‡ºå›°éš¾å®¶åº­è®¤å®šã€‚åˆç†ç¡®å®šè°ƒæ•´æœ€ä½ç”Ÿæ´»ä¿éšœæ ‡å‡†ï¼Œä¸åŸä¹¡å±…æ°‘äººå‡æ¶ˆè´¹æ”¯å‡ºç›¸æŒ‚é’©ï¼Œåˆ‡å®ä¿éšœå›°éš¾ç¾¤ä¼—åŸºæœ¬ç”Ÿæ´»ã€‚åŠ å¼ºæœ€ä½ç”Ÿæ´»ä¿éšœæ ‡å‡†ä¸å…¶ä»–ç¤¾ä¼šæ•‘åŠ©æ ‡å‡†çš„ç»Ÿç­¹è¡”æ¥ã€‚å®Œå–„æœ€ä½å·¥èµ„æ ‡å‡†è°ƒæ•´æœºåˆ¶ï¼Œåˆç†æé«˜æœ€ä½å·¥èµ„æ ‡å‡†ã€‚åˆ¶å®šæŠ€èƒ½äººæ‰æœ€ä½å·¥èµ„åˆ†ç±»å‚è€ƒæŒ‡å¼•ã€‚å®æ–½å†œæ‘ä½æ”¶å…¥äººå£å¼€å‘å¼å¸®æ‰¶æèƒ½å¢æ”¶è¡ŒåŠ¨ï¼Œå»ºç«‹å†œæ‘ä½æ”¶å…¥å®¶åº­åŠ³åŠ¨åŠ›åŠ³åŠ¨ä¼¤å®³å¸®æ‰¶æœºåˆ¶ã€‚åŠ å¤§ä»¥å·¥ä»£èµˆå®æ–½åŠ›åº¦ï¼Œä¼˜å…ˆå¸çº³å¸¦åŠ¨ä½æ”¶å…¥äººå£å°±åœ°å°±è¿‘å°±ä¸šå¢æ”¶ã€‚

# äºŒã€æé«˜åŸºæœ¬å…¬å…±æœåŠ¡å‡è¡¡æ€§

# ï¼ˆä¸‰ï¼‰å…¨æ–¹ä½æé«˜åŸºæœ¬å…¬å…±æœåŠ¡è´¨æ•ˆã€‚ä¾æ®å›½å®¶åŸºæœ¬å…¬å…±æœåŠ¡æ ‡å‡†ï¼Œç»†åŒ–åˆ¶å®šåˆ†åœ°åŒºåˆ†é¢†åŸŸåŸºæœ¬æœåŠ¡é¡¹ç›®æ¸…å•ã€åŸºæœ¬è´¨é‡æ ‡å‡†ã€å‡è¡¡è¯„ä¼°åŠæ³•ã€‚æ ¹æ®ç»æµç¤¾ä¼šå‘å±•æ°´å¹³å’Œè´¢æ”¿å¯æ‰¿å—èƒ½åŠ›ï¼Œé€‚æ—¶å°†æ¶‰åŠç¾¤ä¼—åˆ‡èº«åˆ©ç›Šçš„å¢é‡æœåŠ¡äº‹é¡¹çº³å…¥å›½å®¶åŸºæœ¬å…¬å…±æœåŠ¡æ ‡å‡†ã€‚æ¨åŠ¨åŸºæœ¬å…¬å…±æœåŠ¡ä¾›ç»™ä¸äººå£å˜åŒ–ç›¸åè°ƒï¼ŒæŒ‰ç…§æœåŠ¡åŠå¾„åˆç†ã€è§„æ¨¡é€‚åº¦ã€åŠŸèƒ½é€‚ç”¨ã€ä¿éšœæœ‰åŠ›è¦æ±‚ï¼Œä¼˜åŒ–æœåŠ¡è®¾æ–½å»ºè®¾å’Œè¿è¡Œç®¡ç†ã€‚æ”¯æŒå„åœ°å»ºç«‹å¥å…¨å­˜é‡å…¬å…±æœåŠ¡è®¾æ–½ç»Ÿç­¹åˆ©ç”¨æœºåˆ¶ã€‚ä»¥å¿åŸŸä¸ºåŸºæœ¬å•å…ƒï¼Œå…¨é¢æ¨è¿›å…¬å…±æœåŠ¡è§„åˆ’å¸ƒå±€ã€è®¾æ–½å»ºè®¾ã€èµ„æºé…ç½®ã€äººæ‰è°ƒé…åŸä¹¡ä¸€ä½“åŒ–ã€‚æ”¯æŒé¢å‘è‰°è‹¦è¾¹è¿œåœ°åŒºå†œæ‘æä¾›å½¢å¼çµæ´»çš„åŸºæœ¬å…¬å…±æœåŠ¡ã€‚ä¼˜åŒ–åŸºæœ¬å…¬å…±æœåŠ¡ä¾›ç»™æ–¹å¼ï¼Œç¬¦åˆæ¡ä»¶çš„æ–°å¢åŸºæœ¬å…¬å…±æœåŠ¡äº‹é¡¹ä¼˜å…ˆä»¥æ”¿åºœè´­ä¹°æœåŠ¡æ–¹å¼æä¾›ã€‚æ¨åŠ¨æ•°å­—æ™ºèƒ½æŠ€æœ¯ä¸å…¬å…±æœåŠ¡æ·±åº¦èåˆï¼ŒåŠ å¿«ä¿¡æ¯æ•°æ®äº’é€šå…±äº«ï¼Œæ¨è¿›å©šå§»ç™»è®°ç­‰å¸¸ç”¨æœåŠ¡äº‹é¡¹å–æ¶ˆæˆ·ç±åœ°é™åˆ¶å…¨å›½é€šåŠï¼Œæ‰©å¤§ä¼˜è´¨æ•°å­—å…¬å…±æœåŠ¡èµ„æºè¦†ç›–é¢ã€‚

# ï¼ˆå››ï¼‰æ¨è¡Œç”±å¸¸ä½åœ°æä¾›åŸºæœ¬å…¬å…±æœåŠ¡ã€‚é‡‡å–å¸¸ä½åœ°ç›´æ¥æä¾›ã€è·¨åŒºåŸŸååŒç»åŠã€å®Œå–„è½¬ç§»æ¥ç»­ç­‰æ–¹å¼ï¼Œé€æ­¥å°†åŸºæœ¬å…¬å…±æœåŠ¡è°ƒæ•´ä¸ºå¸¸ä½åœ°æä¾›ã€‚æ¨åŠ¨äººå£é›†ä¸­æµå…¥åœ°åŸå¸‚â€œä¸€åŸä¸€ç­–â€åˆ¶å®šå¸¸ä½åœ°æä¾›åŸºæœ¬å…¬å…±æœåŠ¡å®æ–½åŠæ³•ï¼Œæ¨åŠ¨ç¬¦åˆæ¡ä»¶çš„å†œä¸šè½¬ç§»äººå£äº«æœ‰åŒè¿å…¥åœ°æˆ·ç±äººå£åŒç­‰æƒåˆ©ã€‚ç¨³æ­¥æ¨è¿›çµæ´»å°±ä¸šäººå‘˜å‚åŠ ä½æˆ¿å…¬ç§¯é‡‘åˆ¶åº¦ã€‚æ”¯æŒå„åœ°ç»Ÿç­¹èµ„é‡‘æ¸ é“ï¼ŒåŠ å¤§ä¿éšœæ€§ä½æˆ¿ä¾›ç»™ï¼Œå¼•å¯¼æ”¯æŒç¤¾ä¼šåŠ›é‡è¿è¥é•¿æœŸç§Ÿèµä½æˆ¿ã€‚

# ä¸‰ã€æ‰©å¤§åŸºç¡€æ°‘ç”ŸæœåŠ¡æ™®æƒ æ€§

# ï¼ˆäº”ï¼‰æ¨åŠ¨æ•™è‚²èµ„æºæ‰©ä¼˜æè´¨ã€‚å®æ–½åŸºç¡€æ•™è‚²æ‰©ä¼˜æè´¨è¡ŒåŠ¨è®¡åˆ’ï¼Œé€šè¿‡æŒ–æ½œæ‰©å®¹æ‰©å¤§ç°æœ‰ä¼˜è´¨ä¸­å°å­¦æ ¡ã€å…¬åŠå¹¼å„¿å›­å­¦ä½ä¾›ç»™ï¼Œå°†ä¹‰åŠ¡æ•™è‚²åŸºç¡€è–„å¼±å­¦æ ¡çº³å…¥ä¼˜è´¨å­¦æ ¡é›†å›¢åŒ–åŠå­¦æˆ–æ‰˜ç®¡å¸®æ‰¶ã€‚ç”¨5å¹´å·¦å³æ—¶é—´ï¼Œé€æ­¥å®ç°ä¹‰åŠ¡æ•™è‚²å­¦æ ¡æ ‡å‡†åŒ–å»ºè®¾å…¨è¦†ç›–ã€‚æ–°å»ºæ”¹æ‰©å»º1000æ‰€ä»¥ä¸Šä¼˜è´¨æ™®é€šé«˜ä¸­ï¼Œé‡ç‚¹æ”¹å–„å¿åŸŸæ™®é€šé«˜ä¸­åŸºæœ¬åŠå­¦æ¡ä»¶ã€‚åŠ å¿«æ‰©å¤§ä¼˜è´¨æ™®é€šé«˜ä¸­æ‹›ç”ŸæŒ‡æ ‡åˆ°æ ¡æ¯”ä¾‹ï¼Œä¸»è¦ä¾æ®å­¦ç”Ÿè§„æ¨¡åˆ†é…åˆ°åŒºåŸŸå†…åˆä¸­å­¦æ ¡ï¼Œå¹¶å‘å†œæ‘å­¦æ ¡ç­‰å€¾æ–œã€‚æ¨åŠ¨é«˜ç­‰æ•™è‚²æè´¨æ‰©å®¹ï¼Œæ–°å¢é«˜ç­‰æ•™è‚²èµ„æºé€‚åº¦å‘ä¸­è¥¿éƒ¨äººå£å¤§çœå€¾æ–œã€‚æ”¯æŒå¸ƒå±€æ–°å‹ç ”ç©¶å‹å¤§å­¦å’Œé«˜æ°´å¹³ä¸­å¤–åˆä½œåŠå­¦ï¼Œé€æ­¥æé«˜ä¼˜è´¨é«˜æ ¡æœ¬ç§‘æ‹›ç”Ÿè§„æ¨¡ã€‚å…¨é¢æ·±åŒ–äº§æ•™èåˆæ”¹é©ï¼Œå¼•å¯¼é«˜æ ¡é¢å‘ç»æµç¤¾ä¼šå‘å±•éœ€è¦å®Œå–„å­¦ç§‘ä¸“ä¸šè®¾ç½®è°ƒæ•´æœºåˆ¶ï¼Œå¼ºåŒ–è¡Œä¸šä¼ä¸šå®è·µåŸ¹å…»ï¼Œæ”¯æŒé«˜æ ¡é’ˆå¯¹ç¤¾ä¼šæ€¥éœ€ç´§ç¼ºæŠ€èƒ½å¼€å±•â€œå¾®ä¸“ä¸šâ€å»ºè®¾ï¼Œå¢å¼ºå­¦ç”Ÿå°±ä¸šåˆ›ä¸šèƒ½åŠ›ã€‚

# ï¼ˆå…­ï¼‰æ¨è¿›ä¼˜è´¨åŒ»ç–—å«ç”Ÿèµ„æºå…±äº«ã€‚æ¨è¿›ä¼˜è´¨åŒ»ç–—èµ„æºæ‰©å®¹ä¸‹æ²‰å’ŒåŒºåŸŸå‡è¡¡å¸ƒå±€ï¼Œä¼˜åŒ–åŒºåŸŸåŒ»ç–—ä¸­å¿ƒå»ºè®¾æ¨¡å¼ã€ç®¡ç†ä½“åˆ¶å’Œè¿è¡Œæœºåˆ¶ã€‚å®æ–½åŒ»ç–—å«ç”Ÿå¼ºåŸºå·¥ç¨‹ï¼Œæ¨åŠ¨åŸå¸‚åŒ»ç–—èµ„æºå‘å¿çº§åŒ»é™¢å’ŒåŸä¹¡åŸºå±‚ä¸‹æ²‰ï¼Œé€æ­¥å®ç°ç´§å¯†å‹å¿åŸŸåŒ»å…±ä½“å»ºè®¾å…¨è¦†ç›–ã€‚æ”¯æŒé«˜æ°´å¹³åŒ»é™¢äººå‘˜ã€æœåŠ¡ã€æŠ€æœ¯ã€ç®¡ç†ç­‰å‘åŸºå±‚åŒ»ç–—å«ç”Ÿæœºæ„ä¸‹æ²‰ï¼Œæ¨è¿›åŸå¸‚åŒ»è”ä½“å»ºè®¾ã€‚æ”¯æŒé«˜æ°´å¹³åŒ»å­¦äººæ‰å‘å¿çº§åŒ»é™¢ä¸‹æ²‰ï¼Œé‡ç‚¹å¼ºåŒ–åŸºå±‚åŒ»ç–—å«ç”Ÿæœºæ„çŸ­æ¿ä¸“ä¸šå»ºè®¾ï¼Œå› åœ°åˆ¶å®œåŸ¹è‚²åŠå¥½åŸºå±‚ç‰¹è‰²ä¸“ç§‘ï¼Œæé«˜å¸¸è§ç—…å¤šå‘ç—…è¯Šæ²»æ°´å¹³ï¼Œæ¨åŠ¨åŸºå±‚åŒ»ç–—å«ç”Ÿæœºæ„æé«˜æœåŠ¡èƒ½åŠ›ã€‚æ¨åŠ¨å»ºç«‹è¿œç¨‹åŒ»ç–—æœåŠ¡ç½‘ç»œï¼Œæ¨å¹¿â€œåˆ†å¸ƒå¼æ£€æŸ¥ã€é›†ä¸­å¼è¯Šæ–­â€åŒ»ç–—æœåŠ¡æ¨¡å¼ã€‚å®Œå–„åŸºæœ¬åŒ»ç–—ä¿é™©è¯å“ç›®å½•è°ƒæ•´æœºåˆ¶ï¼Œåˆ¶å®šå‡ºå°å•†ä¸šå¥åº·ä¿é™©åˆ›æ–°è¯å“ç›®å½•ï¼Œæ›´å¥½æ»¡è¶³äººæ°‘ç¾¤ä¼—å¤šå±‚æ¬¡ç”¨è¯ä¿éšœéœ€æ±‚ã€‚

# ï¼ˆä¸ƒï¼‰å¤§åŠ›å‘å±•â€œä¸€è€ä¸€å°â€æ™®æƒ æœåŠ¡ã€‚æ¨åŠ¨å„åœ°å¤šæ¸ é“æ‰©å¤§â€œä¸€è€ä¸€å°â€æœåŠ¡ä½æˆæœ¬åœºåœ°è®¾æ–½ä¾›ç»™ã€‚æ”¯æŒâ€œä¸€è€ä¸€å°â€æœåŠ¡æœºæ„æä¾›è´¨é‡æœ‰ä¿éšœã€ä»·æ ¼å¯æ‰¿å—ã€è¿è¥å¯æŒç»­çš„æ™®æƒ æœåŠ¡ã€‚å®Œå–„æ™®æƒ å…»è€ã€æ™®æƒ æ‰˜è‚²æœåŠ¡ä»·æ ¼å½¢æˆæœºåˆ¶ï¼Œå¯¹åŸºæœ¬æœåŠ¡æ”¶è´¹åŠ å¼ºå¼•å¯¼ã€‚ä»¥å¤±èƒ½è€å¹´äººç…§æŠ¤ä¸ºé‡ç‚¹ï¼Œæé«˜å…»è€æœåŠ¡æœºæ„åŒ»å…»ç»“åˆæœåŠ¡èƒ½åŠ›ï¼Œå¢åŠ æŠ¤ç†å‹åºŠä½ä¾›ç»™ï¼Œæ–°å»ºå…»è€æœºæ„æŠ¤ç†å‹åºŠä½å æ¯”åŸåˆ™ä¸Šä¸ä½äº80%ã€‚æ”¯æŒæ™®æƒ å…»è€æœåŠ¡å¢é‡èµ„æºå‘ç¤¾åŒºå€¾æ–œï¼Œå¢å¼ºæ—¥é—´ç…§æ–™ã€åº·å¤æŠ¤ç†ã€ä¸Šé—¨æœåŠ¡ç­‰èƒ½åŠ›ï¼Œç§¯æå‘å±•å®¶åº­å…»è€åºŠä½ï¼Œå®Œå–„å®¶åº­å…»è€æ”¯æŒæ”¿ç­–ã€‚ç§¯æå‘å±•å†œæ‘äº’åŠ©æ€§å…»è€æœåŠ¡ï¼Œå¼•å¯¼æœ‰æ¡ä»¶çš„ä¹¡é•‡æ•¬è€é™¢å‘ç¤¾ä¼šæä¾›æœåŠ¡ï¼Œä¼˜å…ˆæ»¡è¶³å­¤å¯¡ã€æ®‹éšœå¤±èƒ½ã€é«˜é¾„ç•™å®ˆå’Œä½ä¿å®¶åº­è€å¹´äººç…§æŠ¤éœ€æ±‚ã€‚å¤šæ¸ é“å¢åŠ å…¬å»ºæ‰˜ä½ä¾›ç»™ï¼Œå¤§åŠ›å‘å±•ç¤¾åŒºåµŒå…¥å¼æ‰˜è‚²å’Œå®¶åº­æ‰˜è‚²ç‚¹ï¼Œæ”¯æŒæœ‰æ¡ä»¶çš„å¹¼å„¿å›­å»¶ä¼¸å‘å±•æ‰˜è‚²æœåŠ¡ï¼Œç”¨10å¹´å·¦å³æ—¶é—´ï¼Œæ¨åŠ¨æœ‰æ¡ä»¶çš„å¤§åŸå¸‚é€æ­¥å®ç°åµŒå…¥å¼ç­‰æ™®æƒ æ‰˜è‚²è¦†ç›–80%ä»¥ä¸Šç¤¾åŒºã€‚æ¨åŠ¨æ™®æƒ æ‰˜è‚²çº³å…¥ä¼äº‹ä¸šå•ä½èŒå·¥ç¦åˆ©ä½“ç³»ï¼Œç”¨äººå•ä½å¼€å±•æ™®æƒ æ‰˜è‚²æœåŠ¡çš„æœ‰å…³æ”¯å‡ºï¼ŒæŒ‰è§„å®šä»èŒå·¥ç¦åˆ©è´¹ä¸­åˆ—æ”¯ï¼Œç”¨äººå•ä½å·¥ä¼šç»è´¹å¯ä»¥é€‚å½“è¡¥å……ã€‚

# å››ã€æå‡å¤šæ ·åŒ–ç¤¾ä¼šæœåŠ¡å¯åŠæ€§

# ï¼ˆå…«ï¼‰å‘å±•ç¾¤ä¼—å®¶é—¨å£çš„ç¤¾åŒºæœåŠ¡ã€‚ä»¥ç¤¾åŒºä¸ºä¸»åœºæ™¯ä¸»é˜µåœ°ï¼ŒåŠ å¼ºå„ç±»ä¾¿æ°‘æœåŠ¡èµ„æºç»Ÿç­¹æ•´åˆï¼Œæ¨è¿›æœåŠ¡è®¾æ–½å¤åˆåˆ©ç”¨ï¼Œå®Œå–„ç¤¾åŒºåµŒå…¥å¼æœåŠ¡è®¾æ–½ï¼Œæä¾›ä¸€ç«™å¼ä¾¿æ°‘æœåŠ¡ã€‚æ”¯æŒå…»è€ã€æ‰˜è‚²ã€å®¶æ”¿ã€åŠ©é¤ã€åŠ©æ®‹ç­‰æ™®æƒ ç¤¾ä¼šæœåŠ¡è¿›ç¤¾åŒºï¼Œå…è®¸æä¾›ç¤¾åŒºç¾¤ä¼—æ€¥éœ€æœåŠ¡çš„ç»è¥ä¸»ä½“åœ¨ç¡®ä¿å®‰å…¨è§„èŒƒå‰æä¸‹ç§Ÿèµæ™®é€šä½å®…è®¾ç½®æœåŠ¡ç½‘ç‚¹ã€‚å……åˆ†åˆ©ç”¨ç¤¾ä¼šåŒ–èµ„æºï¼Œå› åœ°åˆ¶å®œå‘å±•è€å¹´åŠ©é¤æœåŠ¡ã€‚åŠ å¼ºå®¶åº­æ•™è‚²ç¤¾åŒºæ”¯æŒï¼Œå»ºè®¾ç¾¤ä¼—å¯æ„Ÿå¯åŠçš„ç¤¾åŒºå…¬å…±æ–‡åŒ–ç©ºé—´ï¼Œæ”¯æŒç¤¾åŒºå¹¿æ³›å¼€å±•é‚»é‡Œäº’åŠ©æœåŠ¡ã€‚

# ï¼ˆä¹ï¼‰æé«˜å¤šæ ·åŒ–ç”Ÿæ´»æœåŠ¡å“è´¨ã€‚å®Œå–„å…¨æ°‘å¥èº«å…¬å…±æœåŠ¡ä½“ç³»ï¼Œæ¨è¿›ä½“è‚²å…¬å›­ã€å¥èº«æ­¥é“ç­‰å»ºè®¾ï¼Œæ”¯æŒç¤¾ä¼šä½“è‚²åœºåœ°å»ºè®¾ï¼Œå‘å±•åŠŸèƒ½å¤åˆçš„å¤šç”¨é€”è¿åŠ¨åœºåœ°ï¼Œç¨³æ­¥å¢åŠ ä½“è‚²åœºåœ°ä¾›ç»™ã€‚æ¨åŠ¨æ–‡åŒ–ã€æ—…æ¸¸ã€å¥åº·ã€ä½“è‚²ç­‰ä¸šæ€èåˆå‘å±•ã€‚ç§¯ææ¨åŠ¨å°†åˆ©ç”¨ç‡é«˜çš„ä¸­å°å‹ä½“è‚²åœºé¦†ã€å…¨æ°‘å¥èº«ä¸­å¿ƒå‘ç¤¾ä¼šå…è´¹æˆ–ä½æ”¶è´¹å¼€æ”¾ã€‚æ”¯æŒæœ‰æ¡ä»¶çš„åšç‰©é¦†ã€å›¾ä¹¦é¦†ã€ç¾æœ¯é¦†ç­‰æ–‡åŒ–åœºé¦†å¤œé—´å¼€æ”¾ã€‚æ”¯æŒæœ‰æ¡ä»¶çš„åœ°åŒºä¾æ‰˜æˆ·å¤–è¿åŠ¨ä¼˜è´¨èµ„æºå’Œä¼˜åŠ¿é¡¹ç›®ï¼Œæ‰“é€ è®¾æ–½å®Œå–„ã€æœåŠ¡ä¼˜è´¨ã€èµ›äº‹ä¸°å¯Œçš„é«˜è´¨é‡æˆ·å¤–è¿åŠ¨ç›®çš„åœ°ã€‚æ¨åŠ¨å…¨æ°‘é˜…è¯»ï¼Œå»ºè®¾è¦†ç›–åŸä¹¡ã€å®ç”¨ä¾¿åˆ©ã€æœåŠ¡é«˜æ•ˆçš„å…¨æ°‘é˜…è¯»è®¾æ–½ã€‚

# ï¼ˆåï¼‰ä¿ƒè¿›åŒ…å®¹å…±äº«å‘å±•ã€‚åœ¨å…¬å…±æ”¿ç­–åˆ¶å®šã€å…¬å…±è®¾æ–½å»ºè®¾ã€å…¬å…±æœåŠ¡ä¾›ç»™ä¸­è½å®å„¿ç«¥ä¼˜å…ˆåŸåˆ™å’Œå„¿ç«¥å‹å¥½ç†å¿µã€‚æå‡å„¿ç«¥ç¦åˆ©æœåŠ¡æœºæ„æ—¥å¸¸ç”Ÿæ´»ç…§æ–™ã€åŸºæœ¬åŒ»ç–—ã€åŸºæœ¬åº·å¤ã€æ•™è‚²æƒç›Šä¿éšœã€ç¤¾ä¼šå·¥ä½œèƒ½åŠ›ã€‚æ·±åŒ–â€œçˆ±å¿ƒå¦ˆå¦ˆâ€ç»“å¯¹å…³çˆ±ï¼Œå¸®åŠ©è§£å†³ç•™å®ˆå„¿ç«¥ã€å›°å¢ƒå„¿ç«¥äº²æƒ…é™ªä¼´ã€å®‰å…¨ç…§æŠ¤ç­‰æ–¹é¢çš„å®é™…é—®é¢˜ã€‚å®Œå–„é’å¹´å‘å±•ä¿ƒè¿›æ”¿ç­–ï¼Œä¸ºé’å¹´åœ¨æ±‚å­¦å·¥ä½œã€å©šæ‹ç”Ÿè‚²ã€ç¤¾ä¼šèå…¥ç­‰æ–¹é¢æä¾›æ›´å¤šæ”¯æŒã€‚å¼•å¯¼æ”¯æŒåœ¨ä¿éšœæ€§ä½æˆ¿ä¸­åŠ å¤§å…¼é¡¾èŒä½å¹³è¡¡çš„å®¿èˆå‹ã€å°æˆ·å‹é’å¹´å…¬å¯“ä¾›ç»™ã€‚æ¸…ç†å–æ¶ˆé™åˆ¶è€å¹´äººç¤¾ä¼šå‚ä¸çš„ä¸åˆç†æ”¿ç­–è§„å®šï¼Œæ”¯æŒæ¨å¹¿â€œä»¥è€åŠ©è€â€æœåŠ¡æ¨¡å¼ï¼Œå¼€å‘é€‚åˆå¤§é¾„åŠ³åŠ¨è€…çš„å¤šæ ·åŒ–å·¥ä½œå²—ä½ã€‚å¤§åŠ›å‘å±•è€å¹´ç”¨æˆ·å‹å¥½çš„æ™ºèƒ½æŠ€æœ¯äº§å“å’Œåº”ç”¨ï¼Œæ¨åŠ¨å…¬å…±è®¾æ–½ã€å±…æ°‘ä½å®…ç­‰å¤šå±‚å»ºç­‘åŠ è£…ç”µæ¢¯ã€‚å®Œå–„å›°éš¾æ®‹ç–¾äººç”Ÿæ´»è¡¥è´´ã€é‡åº¦æ®‹ç–¾äººæŠ¤ç†è¡¥è´´æ ‡å‡†åŠ¨æ€è°ƒæ•´æœºåˆ¶ã€‚å®Œå–„å­•æœŸå¦‡å¥³äº§å‰æ£€æŸ¥åŸºæœ¬æœåŠ¡ï¼Œé¼“åŠ±æœ‰æ¡ä»¶çš„åœ°æ–¹ä¸ºé€‚é¾„å¥³å­©æ¥ç§äººä¹³å¤´ç˜¤ç—…æ¯’ï¼ˆHPVï¼‰ç–«è‹—ã€‚å…¨é¢æ¨è¿›åŸä¹¡å…¬å…±ç©ºé—´é€‚å„¿åŒ–ã€é€‚è€åŒ–å’Œæ— éšœç¢æ”¹é€ ã€‚å®Œå–„ç¤¾ä¼šä¿é™©ã€ç¤¾ä¼šç¦åˆ©ã€ç¨æ”¶ç­‰æ–¹é¢æ”¯æŒå®¶åº­å‘å±•æ”¿ç­–ã€‚

# äº”ã€ä¿éšœæªæ–½

# å„åœ°åŒºå„æœ‰å…³éƒ¨é—¨è¦åœ¨å…šä¸­å¤®é›†ä¸­ç»Ÿä¸€é¢†å¯¼ä¸‹ï¼ŒæŠŠå…šçš„é¢†å¯¼è´¯å½»åˆ°æ°‘ç”Ÿå·¥ä½œçš„å„é¢†åŸŸå…¨è¿‡ç¨‹ï¼Œç»“åˆå®é™…æŠ“å¥½æœ¬æ„è§è´¯å½»è½å®ã€‚æŒ‰ç…§ä¸­å¤®å’Œåœ°æ–¹è´¢æ”¿äº‹æƒå’Œæ”¯å‡ºè´£ä»»åˆ’åˆ†ï¼Œå‘æŒ¥è´¢æ”¿è½¬ç§»æ”¯ä»˜ä¿ƒè¿›åŸºæœ¬å…¬å…±æœåŠ¡å‡ç­‰åŒ–ä½œç”¨ã€‚æé«˜é¢„ç®—å†…æŠ•èµ„æ”¯æŒç¤¾ä¼šäº‹ä¸šæ¯”é‡ã€‚å„åœ°è¦å¼ºåŒ–è´£ä»»è½å®ï¼ŒåšæŒå°½åŠ›è€Œä¸ºã€é‡åŠ›è€Œè¡Œï¼Œä¼˜åŒ–è´¢æ”¿æ”¯å‡ºç»“æ„ï¼Œå¼ºåŒ–åŸºæœ¬æ°‘ç”Ÿè´¢åŠ›ä¿éšœï¼ŒæŒç»­å®Œå–„æ•™è‚²ã€å«ç”Ÿå¥åº·ã€ç¤¾ä¿ã€å°±ä¸šç­‰é‡ç‚¹æ°‘ç”Ÿé¢†åŸŸæ”¯æŒæ”¿ç­–ï¼Œåˆ‡å®å…œä½å…œç‰¢æ°‘ç”Ÿåº•çº¿ã€‚å®Œå–„å„çº§æ”¿åºœæ°‘ç”Ÿå®äº‹æ¸…å•åˆ¶åº¦ã€‚åŠ å¼ºé‡å¤§æ°‘ç”Ÿæ”¿ç­–è·¨éƒ¨é—¨ç»Ÿç­¹åè°ƒï¼Œåœ¨å®è§‚æ”¿ç­–å–å‘ä¸€è‡´æ€§è¯„ä¼°æ—¶æ³¨é‡ä»ç¤¾ä¼šå…¬å¹³è§’åº¦è¯„ä¼°å¯¹ç¤¾ä¼šé¢„æœŸçš„å½±å“ã€‚ç§‘å­¦è¯„ä»·æ°‘ç”Ÿæ”¿ç­–å®æ–½æ•ˆæœï¼Œå¯¹å…¨å›½å±‚é¢çš„é¢„æœŸæ€§æ°‘ç”ŸæŒ‡æ ‡ï¼Œä¸æå±‚å±‚åˆ†è§£å’Œâ€œä¸€åˆ€åˆ‡â€è€ƒæ ¸ã€‚

# è¯·ä»¿ç…§ä»¥ä¸Šå†…å®¹çš„æ ¼å¼ï¼Œå†™ä¸€æ®µå…³äºè„±è´«æ”»åšçš„å®æ–½æ„è§ï¼Œè¯·ä½ ä¸€å®šè¦æœç´¢ï¼Œè¿›å…¥researcher_teamï¼Œä¸è¦ç”Ÿæˆç½‘ç»œå¼•ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨æºæ–‡ä»¶åç§°ã€‚"""

content = """è¯·å†™ä¸€æ®µå…³äºè„±è´«æ”»åšçš„å®æ–½æ„è§ã€‚"""

data = {
    "messages": [
        {
            "role": "user",
            "content": content,
            # '''
            # ä¹ è¿‘å¹³è®ºä¸­å›½æ¢¦æœ‰å“ªäº›å†…å®¹ï¼Œè¯·ä½ ä¸€å®šè¦æœç´¢ï¼Œä¸è¦ç”Ÿæˆç½‘ç»œå¼•ç”¨ï¼Œè€Œæ˜¯ä½¿ç”¨æºæ–‡ä»¶åç§°
            # '''
        }
    ],
    "resources": [],
    "thread_id": "__default__",
    "max_plan_iterations": 1,
    "max_step_num": 3,
    "max_search_results": 3,
    "auto_accepted_plan": True,
    "interrupt_feedback": "string",
    "mcp_settings": {},
    "enable_background_investigation": True,
    "graph_format": "sp_xxqg",
}

# ç”¨äºç¼“å­˜ event æ•°æ®
buffer = ""


def pretty_print_sheet(questions):
    type_labels = {"Select": "[å•é€‰]", "MultiSelect": "[å¤šé€‰]", "TextArea": "[å¡«ç©º]"}

    print("ğŸ“ å†™ä½œåŠ©æ‰‹ç­”é¢˜å¡\n")

    for idx, q in enumerate(questions, start=1):
        title = q["question"]
        q_type = q["type"]
        options = q["options"]

        # æ‰“å°é¢˜ç›®ç¼–å·å’Œæ ‡é¢˜ + ç±»å‹
        print(f"{idx}. {title}ï¼Ÿ{type_labels.get(q_type, '[æœªçŸ¥]')}")

        if q_type in ["Select", "MultiSelect"]:
            # æ‰“å°é€‰é¡¹ A, B, C...
            for i, option in enumerate(options):
                letter = chr(65 + i)  # 65 = 'A'
                print(f"   {letter}. {option}")
        elif q_type == "TextArea":
            print("   ï¼ˆè¯·åœ¨æ­¤å¤„å¡«å†™å†…å®¹ï¼‰")

        print()  # ç©ºè¡Œåˆ†éš”

    # å¼€å§‹æ”¶é›†ç”¨æˆ·å›ç­”
    print("è¯·é€æ¡å›ç­”é—®é¢˜ï¼š")
    print("ğŸ‘‰ é€‰æ‹©é¢˜è¯·è¾“å…¥é€‰é¡¹å­—æ¯ï¼ˆå¦‚ A æˆ– Aã€Bï¼‰ï¼Œå¡«ç©ºé¢˜ç›´æ¥å†™å†…å®¹ã€‚")
    print("ğŸ”š æ¯è¡Œä¸€ä¸ªç­”æ¡ˆï¼Œè¾“å…¥å®Œåè¾“å…¥ END ç»“æŸï¼š\n")

    answers_parsed = []  # å­˜å‚¨ç»“æ„åŒ–ç­”æ¡ˆ
    answer_lines = []
    answer = input().strip()

    while answer.upper() != "END":
        answer_lines.append(answer)
        answer = input().strip()

    # å°†ç”¨æˆ·è¾“å…¥ä¸é¢˜ç›®ä¸€ä¸€å¯¹åº”è§£æ
    for line, question in zip(answer_lines, questions):
        user_input = line.strip()
        q_type = question["type"]
        options = question["options"]
        parsed_answer = []

        if q_type in ["Select", "MultiSelect"]:
            # æ¸…æ´—è¾“å…¥ï¼šæ”¯æŒ Aã€B æˆ– A,B æˆ– AB ç­‰æ ¼å¼
            import re

            letters = re.split(r"[ã€ï¼Œ,\\s]+", user_input)  # æ”¯æŒå¤šç§åˆ†éš”ç¬¦
            letters = [letter.strip().upper() for letter in letters if letter.strip()]

            for letter in letters:
                if len(letter) == 1 and letter.isalpha():
                    idx = ord(letter) - 65  # A->0, B->1
                    if 0 <= idx < len(options):
                        parsed_answer.append(options[idx])
                    else:
                        print(
                            f"âš ï¸ é€‰é¡¹ {letter} è¶…å‡ºèŒƒå›´ï¼ˆé¢˜ç›®ï¼š{question['question']}ï¼‰ï¼Œå·²å¿½ç•¥ã€‚"
                        )
                else:
                    print(f"âš ï¸ æ— æ•ˆé€‰é¡¹æ ¼å¼ï¼š{letter}ï¼Œå·²å¿½ç•¥ã€‚")

            # å•é€‰åªå–ç¬¬ä¸€ä¸ªï¼ˆå¯é€‰ç­–ç•¥ï¼‰
            if q_type == "Select" and len(parsed_answer) > 1:
                print(
                    f"âš ï¸ æ³¨æ„ï¼š'{question['question']}' æ˜¯å•é€‰é¢˜ï¼Œä»…ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹ '{parsed_answer[0]}'"
                )
                parsed_answer = [parsed_answer[0]]
            parsed_answer = "; ".join(parsed_answer)
        elif q_type == "TextArea":
            # å¡«ç©ºé¢˜ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥æ–‡æœ¬ï¼ˆéé€‰é¡¹ï¼‰
            parsed_answer = user_input  # å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥å­˜ä¸º [user_input] è§†éœ€æ±‚
        else:
            parsed_answer = user_input

        # answers_parsed.append({
        #     "question": question["question"],
        #     "type": q_type,
        #     "answer": parsed_answer  # list of strings (or string for TextArea)
        # })
        answers_parsed.append(parsed_answer)
    return answers_parsed


NEED_RETRY = False


def process_event(event_type, event_data):
    """å¤„ç†ä¸€ä¸ªå®Œæ•´çš„ event"""
    print(event_type, event_data)
    if event_type == "message_chunk":
        content = event_data.get("content", "")
        print(content, end="", flush=True)
        return None
    elif event_type == "interrupt":
        thread_id = event_data.get("thread_id", "")
        content = event_data.get("content", "")
        question = event_data.get("question", "")
        question = json.loads(question)
        if isinstance(question, dict):
            question = question.values()
        elif isinstance(question, list):
            question = question
        else:
            raise ValueError("Unexpected question format")
        print(f"\n\n---\n\n{content}\n\n---\n\n")
        answer_parsed = pretty_print_sheet(question)

        feedback = {
            "thread_id": thread_id,
            "content": "[FILLED_QUESTION]" + "\n".join(answer_parsed),
        }
        return feedback


with httpx.Client(timeout=None) as client:
    with client.stream("POST", url, json=data) as response:
        if response.status_code == 200:
            for chunk in response.iter_text():
                buffer += chunk
                # æŒ‰è¡Œåˆ†å‰²
                while "\n" in buffer:
                    line, buffer = buffer.split("\n", 1)
                    line = line.strip()
                    # è§£æ event å’Œ data
                    if line.startswith("event:"):
                        event_type = line.split(":", 1)[1].strip()
                    elif line.startswith("data:"):
                        data_str = line.split(":", 1)[1].strip()
                        try:
                            event_data = json.loads(data_str)
                            res = process_event(event_type, event_data)
                            if res is not None:
                                data["interrupt_feedback"] = res["content"]
                                data["thread_id"] = res["thread_id"]
                                data["auto_accepted_plan"] = False
                                NEED_RETRY = True
                        except json.JSONDecodeError:
                            pass  # å¿½ç•¥æ— æ•ˆ JSON
        else:
            print(f"Error: {response.status_code}")
            print(response.text)


if NEED_RETRY:
    print("\n\n---\n\næ­£åœ¨æ ¹æ®ä½ çš„å›ç­”ç»§ç»­ç”Ÿæˆå†…å®¹...\n\n---\n\n")
    buffer = ""
    with httpx.Client(timeout=None) as client:
        with client.stream("POST", url, json=data) as response:
            if response.status_code == 200:
                for chunk in response.iter_text():
                    buffer += chunk
                    # æŒ‰è¡Œåˆ†å‰²
                    while "\n" in buffer:
                        line, buffer = buffer.split("\n", 1)
                        line = line.strip()
                        # è§£æ event å’Œ data
                        if line.startswith("event:"):
                            event_type = line.split(":", 1)[1].strip()
                        elif line.startswith("data:"):
                            data_str = line.split(":", 1)[1].strip()
                            try:
                                event_data = json.loads(data_str)
                                process_event(event_type, event_data)
                            except json.JSONDecodeError:
                                pass  # å¿½ç•¥æ— æ•ˆ JSON
            else:
                print(f"Error: {response.status_code}")
                print(response.text)
